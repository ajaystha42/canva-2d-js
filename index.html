<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/konva@8.4.3/konva.min.js"></script>
    <meta charset="utf-8" />
    <title>Konva Transform Limits Demo</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f0f0;
      }
      #container {
        background-color: bisque;
        position: relative; /* add this line */
        margin-top: 200px;
      }

      #css-code {
        position: absolute;
        top: calc(100% + 10px); /* add this line */
        top: 10px;
        right: 10px;
        padding: 10px;
        background-color: #fff;
        border: 1px solid #000;
        height: 120px;
      }
      #drag-items input {
        height: 100px;
      }
    </style>
  </head>

  <body>
    <div id="container"></div>
    <div id="css-code"></div>
    <div id="drag-items">
      <label draggable="true">Text</label>
      <input type="text" value="This is a text box" draggable="true" />
      <button type="button" draggable="true">Button</button>
      <!-- <button id="delete-button">Delete</button> -->
    </div>
    <script>
      var totalRects = 0;

      var width = window.innerWidth;
      var height = 200;

      // create stage
      var stage = new Konva.Stage({
        container: "container",
        width: width,
        height: height,
      });

      // create layer
      var layer = new Konva.Layer();
      var complexText = new Konva.Text({
        x: 20,
        y: 60,
        text: "Fusemachines\n\nNew York, USA",
        fontSize: 18,
        fontFamily: "Calibri",
        fill: "#555",
        width: 300,
        padding: 20,
        align: "center",
      });

      var rect1 = new Konva.Rect({
        x: 20,
        y: 60,
        stroke: "#555",
        strokeWidth: 5,
        fill: "#ddd",
        width: 300,
        height: complexText.height(),
        shadowColor: "black",
        shadowBlur: 10,
        shadowOffsetX: 10,
        shadowOffsetY: 10,
        shadowOpacity: 0.2,
        cornerRadius: 10,
      });
      layer.add(rect1);
      layer.add(complexText);

      for (let index = 0; index < totalRects.length; index++) {
        var simpleText = new Konva.Text({
          x: stage.width() / 2,
          y: 15,
          text: "Simple Text",
          fontSize: 30,
          fontFamily: "Calibri",
          fill: "green",
          draggable: true,
        });
        layer.add(simpleText);
      }

      stage.add(layer);

      var con = document.getElementById("container");
      var itemURL;

      // bind events
      con.addEventListener("dragover", function (e) {
        e.preventDefault(); // required to allow drop
      });

      con.addEventListener("drop", function (e) {
        e.preventDefault();
        logNumRects();
        // now we need to find pointer position
        // we can't use stage.getPointerPosition() here, because that event
        // is not registered by Konva.Stage
        // we can register it manually:
        stage.setPointersPositions(e);
        // var url = e.dataTransfer.getData("URL");
        // console.log({ url });
        // itemURL = url.includes("input") ? "input" : "button";
        if (itemURL === "input") {
          // create Konva shape to represent input field
          // var complexText = new Konva.Text({
          //   x: 20,
          //   y: 60,
          //   text: "Fusemachines\n\nNew York, USA",
          //   fontSize: 18,
          //   fontFamily: "Calibri",
          //   fill: "#555",
          //   width: 300,
          //   padding: 20,
          //   align: "center",
          // });

          // var inputBox = new Konva.Rect({
          //   x: 20,
          //   y: 60,
          //   stroke: "#555",
          //   strokeWidth: 5,
          //   fill: "#ddd",
          //   width: 300,
          //   height: complexText.height(),
          //   shadowColor: "black",
          //   shadowBlur: 10,
          //   shadowOffsetX: 10,
          //   shadowOffsetY: 10,
          //   shadowOpacity: 0.2,
          //   cornerRadius: 10,
          // });

          var inputBox = new Konva.Rect({
            x: stage.getPointerPosition().x,
            y: stage.getPointerPosition().y,
            width: 200,
            height: 50,
            fill: "#fff",
            stroke: "black",
            strokeWidth: 2,
            draggable: true,
            text: "Text Box",
          });
          console.log({ totalRects });

          // add the shape to the layer
          layer.add(inputBox);

          // redraw the layer
          layer.draw();

          var MAX_WIDTH = window.innerWidth;
          // create new transformer
          var tr = new Konva.Transformer({
            boundBoxFunc: function (oldBoundBox, newBoundBox) {
              // "boundBox" is an object with
              // x, y, width, height and rotation properties
              // transformer tool will try to fit nodes into that box

              // the logic is simple, if new width is too big
              // we will return previous state
              if (Math.abs(newBoundBox.width) > MAX_WIDTH) {
                return oldBoundBox;
              }

              return newBoundBox;
            },
          });
          layer.add(tr);

          // add click event listener to rectangle to show transformer tool
          inputBox.on("click", function () {
            tr.nodes([inputBox]);
            layer.add(tr);
            tr.show();
          });

          // add click event listener to stage to hide transformer tool
          stage.on("click", function (e) {
            // check if clicked on empty space
            if (e.target === stage) {
              tr.hide();
              layer.draw();
            }
          });

          var cssCodeEl = document.querySelector("#css-code");

          tr.on("transform", function () {
            var scaleX = inputBox.scaleX();
            var scaleY = inputBox.scaleY();

            var cssCode = `
              .${inputBox.name()} {
                width: ${inputBox.width() * scaleX}px;
                height: ${inputBox.height() * scaleY}px;
                margin-top: ${inputBox.y()}px;
                margin-left: ${inputBox.x()}px;
                margin-bottom: ${
                  stage.height() - inputBox.y() - inputBox.height()
                }px;
                margin-right: ${
                  stage.width() - inputBox.x() - inputBox.width()
                }px;
                padding-top: ${
                  stage.height() - inputBox.y() - inputBox.height()
                }px;
                padding-left: ${
                  stage.width() - inputBox.x() - inputBox.width()
                }px;
                padding-bottom: ${inputBox.y()}px;
                padding-right: ${inputBox.x()}px;
              }
            `;

            cssCodeEl.textContent = cssCode;
          });

          inputBox.on("dragmove", function () {
            var cssCode = `
        .${inputBox.name()} {
          width: ${inputBox.width()}px\n;
          height: ${inputBox.height()}px;
          margin-top: ${inputBox.y()}px;
          margin-left: ${inputBox.x()}px;
          margin-bottom: ${stage.height() - inputBox.y() - inputBox.height()}px;
          margin-right: ${stage.width() - inputBox.x() - inputBox.width()}px;
          padding-top: ${stage.height() - inputBox.y() - inputBox.height()}px;
          padding-left: ${stage.width() - inputBox.x() - inputBox.width()}px;
          padding-bottom: ${inputBox.y()}px;
          padding-right: ${inputBox.x()}px;
        }
      `;
            cssCodeEl.textContent = cssCode;
          });
          inputBox.on("click", function () {
            var cssCode = `
            .${inputBox.name()} {
              width: ${inputBox.width()}px\n;
              height: ${inputBox.height()}px;
              margin-top: ${inputBox.y()}px;
              margin-left: ${inputBox.x()}px;
              margin-bottom: ${
                stage.height() - inputBox.y() - inputBox.height()
              }px;
              margin-right: ${
                stage.width() - inputBox.x() - inputBox.width()
              }px;
              padding-top: ${
                stage.height() - inputBox.y() - inputBox.height()
              }px;
              padding-left: ${
                stage.width() - inputBox.x() - inputBox.width()
              }px;
              padding-bottom: ${inputBox.y()}px;
              padding-right: ${inputBox.x()}px;
            }
          `;
            cssCodeEl.textContent = cssCode;
          });
        }
      });

      // bind input item drag event
      document
        .querySelector("#drag-items input")
        .addEventListener("dragstart", function (e) {
          itemURL = e.target.tagName.toLowerCase();
        });

      function logNumRects() {
        var rects = stage.find("Rect");
        console.log({ rects: rects.length });
        if (rects.length > 1) {
          ab = "" + rects.length;
          console.log({ ab: ab.split("") });
          totalRects = 0;
          ab.split("").forEach((x) => {
            totalRects += +x;
            // console.log({ x });
          });
        }

        // console.log("Total number of Rect objects in stage: " + rects.length);
      }

      // Call the function to log the initial number of rects in the stage
      logNumRects();
      // Listen for events when rects are added or removed from the stage
      stage.on("drag", function () {
        logNumRects();
      });
    </script>
  </body>
</html>
